version: "3.7"
services:
  consul-server1:
    container_name: consul-server1
    extends:
      file: ../../services/consul.yml
      service: server
    ports:
      - 8500:8500
      - 8600:8600
    volumes:
      - ../../volumes/consul/config/server1.json:/consul/config/server1.json:ro
      - ../../volumes/consul/data1:/consul/data/

  consul-server2:
    container_name: consul-server2
    extends:
      file: ../../services/consul.yml
      service: server
    volumes:
      - ../../volumes/consul/config/server2.json:/consul/config/server2.json:ro
      - ../../volumes/consul/data2:/consul/data/
  
  consul-server3:
    container_name: consul-server3
    extends:
      file: ../../services/consul.yml
      service: server
    volumes:
      - ../../volumes/consul/config/server3.json:/consul/config/server3.json:ro
      - ../../volumes/consul/data3:/consul/data/
    
  consul-client:
    extends:
      file: ../../services/consul.yml
      service: client
    container_name: consul-client
    volumes:
      - ../../volumes/consul/config/client.json:/consul/config/client.json:ro
      - ../../volumes/consul/data4:/consul/data/

  consul-registrator:
    extends:
      file: ../../services/consul.yml
      service: registrator
    container_name: consul-registrator

  caddy:
    container_name: caddy
    extends:
      file: ../../services/caddy.yml
      service: caddy

  rclone:
    container_name: rclone
    extends:
      file: ../../services/rclone.yml
      service: rclone
    command: sync /source/volumes/ onedrive:/rclone-backup/volumes/ --local-no-check-updated --ignore-size --ignore-checksum
    volumes:
      - ./volumes:/source/volumes:ro
    
  vaultwarden:
    container_name: vaultwarden
    extends:
      file: ../../services/vaultwarden.yml
      service: vaultwarden
    labels:
      caddy: password.bone6.top pw.bone6.top

  one-api-db:
    extends:
      file: ../../services/chat.yml
      service: one-api-db

  one-api:
    extends:
      file: ../../services/chat.yml
      service: one-api
    labels:
      caddy: one-api.bone6.top

  lobe-chat:
    container_name: lobe-chat
    extends:
      file: ../../services/chat.yml
      service: lobe-chat
    labels:
      caddy: lobe.bone6.top
      homepage.group: 智能
      homepage.name: LobeChat
      homepage.icon: https://lobe.bone6.top/favicon.ico
      homepage.href: https://lobe.bone6.top
      homepage.description: 开源的高性能聊天机器人框架 LobeChat。
  
  n8n-postgres:
    container_name: n8n-postgres
    extends:
      file: ../../services/n8n.yml
      service: n8n-postgres
  
  n8n:
    container_name: n8n
    extends:
      file: ../../services/n8n.yml
      service: n8n
    links:
      - n8n-postgres:postgres
    labels:
      caddy: n8n.bone6.top

  illa:
    container_name: illa
    extends:
      file: ../../services/illa.yml
      service: illa
    labels:
      caddy: illa.bone6.top

  headscale:
    container_name: headscale
    extends:
      file: ../../services/headscale.yml
      service: server
    labels:
      caddy: headscale.bone6.top

  headscale-derper:
    container_name: headscale-derper
    extends:
      file: ../../services/headscale.yml
      service: derper
    labels:
      caddy: ghk.derp.bone6.top
  
  headscale-ui:
    container_name: headscale-ui
    extends:
      file: ../../services/headscale.yml
      service: ui
    labels:
      caddy: headscale.bone6.top
      homepage.group: 网络
      homepage.name: Headscale
      homepage.icon: https://tailscale.com/favicon.ico
      homepage.href: https://headscale.bone6.top
      homepage.description: Headscale 组网管理

  homepage:
    container_name: homepage
    extends:
      file: ../../services/homepage.yml
      service: base
    volumes:
      - ./configs/homepage:/app/config:ro
    labels:
      caddy: homepage.bone6.top
      caddy.reverse_proxy: "{{upstreams 3000}}"

networks:
  consul:
    driver: bridge

